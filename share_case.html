{extend name="base:base" /}
{block name="body"}



	<form id="picform">
	<!-- 	<div class="weui-cells__title">标题</div>
		<div class="weui-cells">
		  <div class="weui-cell">
		    <div class="weui-cell__bd">
		      <input class="weui-input" type="text" name="title" placeholder="请填写标题">
		    </div>
		  </div>
		</div> -->
		<div class="weui-gallery" id="gallery">
	      <span class="weui-gallery__img" id="galleryImg"></span>
	      <div class="weui-gallery__opr">
	        <a href="javascript:" rel="external nofollow" class="weui-gallery__del">
	          <i class="weui-icon-delete weui-icon_gallery-delete"></i>
	        </a>
	      </div>
	    </div>
	    <div class="weui-cells weui-cells_form">
	      <div class="weui-cell">
	        <div class="weui-cell__bd">
	          <div class="weui-uploader">
	            <div class="weui-uploader__hd">
	              <p class="weui-uploader__title">图片上传</p>
	              <div class="weui-uploader__info js_counter">0/6</div>
	            </div>
	            <div class="weui-uploader__bd">
	              <ul class="weui-uploader__files" id="uploaderFiles">
	                
	              </ul>
	              <div class="weui-uploader__input-box">
	                <input id="uploaderInput" class="weui-uploader__input zjxfjs_file" type="file" accept="image/jpg,image/jpeg,image/png,image/gif" multiple="">
	              </div>
	            </div>
	          </div>
	        </div>
	      </div>
	    </div>	
	    <a href="javascript:;" class="weui-btn weui-btn_primary" onclick="submit()">按钮</a>
    </form>
	

{/block}
{block name="js"}

	<script type="text/javascript">
	  $(function () {
	  	
          	$gallery = $("#gallery"),
          	$galleryImg = $("#galleryImg"),
          	$uploaderFiles = $("#uploaderFiles");
        	
        	//预览图片
	        var index; //第几张图片
	        $uploaderFiles.on("click", "li", function() {
	          index = $(this).index();
	          $galleryImg.attr("style", this.getAttribute("style"));
	          $gallery.fadeIn(100);
	        });
	        $gallery.on("click", function() {
	          $gallery.fadeOut(100);
	        });
	        //删除图片 删除图片的代码也贴出来。
	        $(".weui-gallery__del").click(function() { //这部分刚才放错地方了，放到$(function(){})外面去了
	          console.log('删除');
	          $uploaderFiles.find("li").eq(index).remove();
	        });


		    // 允许上传的图片类型
		    var allowTypes = ['image/jpg', 'image/jpeg', 'image/png', 'image/gif'];
		    // 1024KB，也就是 1MB
		    var maxSize = 1024 * 1024;
		    // 图片最大宽度
		    var maxWidth = 300;
		    // 最大上传图片数量
		    var maxCount = 6;
		    $('.zjxfjs_file').on('change', function (event) {
		        var files = event.target.files;
		 
		        // 如果没有选中文件，直接返回
		        if (files.length === 0) {
		            return;
		        }
		 
		        for (var i = 0, len = files.length; i < len; i++) {
		            var file = files[i];
		            var reader = new FileReader();
		 
		            // 如果类型不在允许的类型范围内
		            if (allowTypes.indexOf(file.type) === -1) {
		                $.weui.alert({text: '该类型不允许上传'});
		                continue;
		            }
		 
		            if (file.size > maxSize) {
		                $.weui.alert({text: '图片太大，不允许上传'});
		                continue;
		            }
		 
		            if ($('.weui_uploader_file').length >= maxCount) {
		                $.weui.alert({text: '最多只能上传' + maxCount + '张图片'});
		                return;
		            }
		 
		            reader.onload = function (e) {
		                var img = new Image();
		                img.onload = function () {
		                    // 不要超出最大宽度
		                    var w = Math.min(maxWidth, img.width);
		                    // 高度按比例计算
		                    var h = img.height * (w / img.width);
		                    var canvas = document.createElement('canvas');
		                    var ctx = canvas.getContext('2d');
		                    // 设置 canvas 的宽度和高度
		                    canvas.width = w;
		                    canvas.height = h;
		                    ctx.drawImage(img, 0, 0, w, h);
		                    var base64 = canvas.toDataURL('image/png');
		 
		                    // 插入到预览区
		                    var $preview = $('<li class="weui-uploader__file weui-uploader__file_status" style="background-image:url(' + base64 + ')"><div class="weui-uploader__file-content">0%</div>'+'<input type="hidden" name="pic[]" value="'+e.target.result+'">'+'</li>');
		                    $('.weui-uploader__files').append($preview);
		                    var num = $('.weui-uploader__file').length;
		                    $('.js_counter').text(num + '/' + maxCount);
		 
		                    // 然后假装在上传，可以post base64格式，也可以构造blob对象上传，也可以用微信JSSDK上传
		 
		                    var progress = 0;
		                    function uploading() {
		                        $preview.find('.weui-uploader__file-content').text(++progress + '%');
		                        if (progress < 100) {
		                            setTimeout(uploading, 30);
		                        }
		                        else {
		                            // 如果是失败，塞一个失败图标
		                            $preview.find('.weui-uploader__file-content').html('<i class="weui-icon-warn"></i>');
		                            $preview.removeClass('weui-uploader__file_status').find('.weui-uploader__file-content').remove();
		                        }
		                    }
		                    setTimeout(uploading, 30);
		                };		 
		                
		            };
		            reader.readAsDataURL(file);
		 
		        }
		    });
		});

		function submit(){
			$.post("{$pathUrl}/Designer/shareCase", $("form").serialize(),function(res){
		          // var object=eval("("+res+")");
		          // if (object.code==1) {
		          // 	$.toptip(object.data, 'success');
		          // }else{
		          // 	$.toptip(object.data, 'error');
		          // }  
		    },'json');
		}



	</script>

{/block}